<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- <script src="./util.js"></script> -->
    <link
      rel="stylesheet"
      href="https://serviceops.connectwise.com/styles/cwstyle.css"
    />
    <title>CW-PST Automation</title>
    <script>
      var myData;
      var taskInventoryUrl = "task-inventory.json";

      function loadJSON(path, success, error) {
        // function to load JSON file as input
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
              if (success) success(JSON.parse(xhr.responseText));
            } else {
              if (error) error(xhr);
            }
          }
        };
        // xhr request
        xhr.open("GET", path, true); //asynchronous request : true
        xhr.send();
      }

      function removeTaskListDrop() {
        var oldmenu = document.getElementById("task-list");
        var optns = oldmenu.getElementsByTagName("option");
        length = optns.length;

        for (var i = length - 1; i > 0; i--) {
          if (optns[i].value != "") {
            optns[i].remove();
          }
        }

        document.getElementById("id-link").value = "";
        document.getElementById("id-title").value = "";
        document.getElementById("id-task-desc").innerHTML = "";
      }

      function showDesc(ele) {
        var taskId = ele.options[ele.selectedIndex].value;
        var divTag = document.getElementById("desc");

        var task = myData.taskList.filter(function (item) {
          return item.taskId == taskId;
        });
        if (task == undefined) {
          document.getElementById("id-link").value = "";
          document.getElementById("id-title").value = "";
          document.getElementById("id-task-desc").value = "";
        }
        // update fields
        document.getElementById("id-link").value = task[0].url;
        document.getElementById("id-title").value = task[0].name;
        document.getElementById("id-task-desc").value = task[0].description;
      }

      function populateTaskList(ele) {
        removeTaskListDrop();

        if (myData.taskList.length < 1) {
          return;
        } else {
          //   first get the task list
          var totalTaskList = myData.taskList;
          var taskList = totalTaskList.filter(function (item) {
            return item.productCategory == ele.options[ele.selectedIndex].value;
          });

          if (null == taskList || taskList.length < 1) {
            console.log(
              "task list for " +
                ele.options[ele.selectedIndex].text +
                "is empty."
            );
            return;
          }

          var selectDropDown = document.getElementById("task-list");

          for (var i = 0; i < taskList.length; i++) {
            var optnEle = document.createElement("option");
            optnEle.setAttribute("value", taskList[i].taskId);
            optnEle.text = taskList[i].name;

            selectDropDown.add(optnEle);
          }
        }
      }

      function populateProd() {
        try {
          if (myData.products.length < 1) {
            return;
          } else {
            var productsList = myData.products;
            var selectDropDown = document.getElementById("product-list");

            for (var i = 0; i < productsList.length; i++) {
              var optnEle = document.createElement("option");
              optnEle.setAttribute("value", productsList[i]);
              optnEle.text = productsList[i];
              selectDropDown.add(optnEle);
            }
          }
        } catch {
          console.log("some exception occured.");
        }
      }

      function initSelection() {
        
        loadJSON(
          taskInventoryUrl,
          function (data) {
            window.myData = data;
            populateProd();
          },
          function (xhr) {
            console.error(xhr);
          }
        );

        //future functions for initialization yet to be written.
      }

      function copyToClipBoard(id) {
        var taskDescElement = document.getElementById(id);
        if (taskDescElement.value == "" || taskDescElement.value == undefined) {
          window.alert("nothing to copy");
        } else {
          taskDescElement.select();
          document.execCommand("copy");
          window.alert("copied to clipboard");
        }
      }

      function downloadTask() {
        $taskUrl = document.getElementById("id-link").value;
        if ($taskUrl === "" || $taskUrl == undefined) {
          alert("please select a task to download");
        } else {
          window.open($taskUrl, "_blank");
        }
      }
    </script>

    <style>
      .inline {
        display: inline-block;
      }

      .verticalalign {
        vertical-align: top;
      }

      /*
      .textbox {
        position: relative;
        background-color: #bfbcb4;
        
      }

*/

      #product-list {
        width: 100px;
      }
    </style>
  </head>

  <body onload="initSelection()">
    <div class="cw-text" >
      <div class="cw-field-label" style="margin-bottom: 8px">
        Select Automation task:
      </div>
      <!-- select product and task -->
      <div id="dd" style="margin-bottom: 8px">
        <div class="cw-field-label inline" style="font-size: 12px;width: 10%">Product:</div>
        <div class="inline" style="width: 89%;">
          <select
            style="font-size: 12px;width: 20%"
            class="cw-select inline"
            id="product-list"
            onchange="populateTaskList(this)"
            style="margin-left: 8px"
          >
            <option value="">-- Select Product --</option>
          </select>

          <select
            style="font-size: 12px;width: 79%"
            class="cw-select inline"
            id="task-list"
            onchange="showDesc(this)"
          >
            <option value="">-- Select Task --</option>
          </select>
        </div>
      </div>
      <!-- select product and task ends here -->
      <!-- Selected: Task Name -->
      <div style="margin-bottom: 8px">
        <div class="cw-field-label inline" style="font-size: 12px;width: 10%">Selected :</div>
        <input
          type="text"
          id="id-title"
          class="cw-input-field inline"
          readonly="readonly"
          style="font-size: 12px;width: 89%; overflow: hidden"
          onclick="this.select();"
          onmouseup="return false;"
          value=""
        />
      </div>

      <!-- task url section -->
      <div style="margin-bottom: 8px; position: relative">
        <div class="cw-field-label inline verticalalign" style="font-size: 12px;width: 10%">
          Task url :
        </div>

        <div
          class="inline verticalalign"
          style="position: relative; width: 89%"
        >
          <div style="width: 100%; position: absolute">
            <input
              type="text"
              id="id-link"
              class="cw-input-field inline"
              readonly="readonly"
              style="font-size: 12px;width: 100%; overflow: hidden"
              onclick="this.select();"
              onmouseup="return false;"
              value=""
            />
          </div>

          <div  style="float: right; position: absolute; top: 0; right: 0">
            <div class="inline" >
              <button
                id="btn-copyurl"
                class="cw-toolbar-button"
                onclick="copyToClipBoard('id-link')"
              >copy url</button>
            </div>
            <div class="inline">
              <button
                id="btn-download"
                class="cw-toolbar-button"
                onclick="downloadTask()"
              >
                Download
              </button>
            </div>  
          </div>
          
        </div>
      </div>

      <!-- description section -->
      <div style="margin-bottom: 8px; margin-top: 30px; position: relative">
        <div
          class="cw-field-label inline verticalalign"
          style="font-size: 12px;width: 10%; margin-bottom: 8px"
        >
          Decription :
        </div>

        <div
          class="inline verticalalign"
          style="position: relative; width: 89%"
        >
          <textarea
            class="cw-textarea"
            name="id-task-desc"
            id="id-task-desc"
            readonly="readonly"
            style="
            font-size: 12px;
              height: auto;
              width: 100%;
              resize: none;
              overflow: hidden;
              background-color: azure;
            "
          ></textarea>
          <div style="float: right; position: absolute; top: 0; right: 0">
            <button
              id="btn-copy"
              class="cw-toolbar-button"
              onclick="copyToClipBoard('id-task-desc')"
            >
              copy
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
